<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Makarios Emporium — Cart</title>
<style>
  body { font-family:'Inter', sans-serif; margin:0; padding:0; background:#fff; }
  .container { max-width:900px; margin:1rem auto; padding:1rem; }
  h1 { text-align:center; margin-bottom:1rem; }
  .cart-item { display:flex; gap:1rem; align-items:center; margin-bottom:1rem; border-bottom:1px solid #eee; padding-bottom:1rem; }
  .cart-item img { width:80px; height:80px; object-fit:cover; border-radius:8px; }
  .cart-info { flex:1; }
  .cart-info h3 { margin:0; }
  .price { color:#e53935; font-weight:700; }
  .qty { display:flex; gap:0.5rem; align-items:center; }
  .qty button { padding:0.3rem 0.6rem; cursor:pointer; }
  .checkout { display:flex; justify-content:space-between; align-items:center; margin-top:1.5rem; }
  .btn { background:#e53935; color:#fff; border:none; border-radius:8px; padding:0.8rem 1.2rem; cursor:pointer; font-weight:600; }

  @media(max-width:768px){
    .cart-item { flex-direction:column; align-items:flex-start; }
    .checkout { flex-direction:column; gap:1rem; }
  }
</style>
<script type="module" src="../firebase.js"></script>
<script src="https://js.paystack.co/v1/inline.js"></script>
</head>
<body>
<div class="container">
  <h1>Your Cart</h1>
  <div id="cartItems"></div>
  <div class="checkout">
    <h2 id="subtotal">Subtotal: ₵0</h2>
    <button class="btn" id="payBtn">Pay with Paystack</button>
  </div>
</div>

<script type="module">
import { db, doc, getDoc } from "../firebase.js";

const cartDiv = document.getElementById("cartItems");
const subtotalEl = document.getElementById("subtotal");
const payBtn = document.getElementById("payBtn");

let cart = JSON.parse(localStorage.getItem("cart") || "{}");
let productsData = {};
let subtotal = 0;

// Load cart products
async function loadCart(){
  subtotal = 0;
  cartDiv.innerHTML = '';
  for(const id in cart){
    const qty = cart[id];
    const docSnap = await getDoc(doc(db, "products", id));
    if(docSnap.exists()){
      const p = docSnap.data();
      productsData[id] = p;
      subtotal += p.price * qty;
      const div = document.createElement("div");
      div.classList.add("cart-item");
      div.innerHTML = `
        <img src="${p.imageUrl}" alt="${p.name}">
        <div class="cart-info">
          <h3>${p.name}</h3>
          <p class="price">₵${p.price}</p>
          <div class="qty">
            <button onclick="changeQty('${id}',-1)">−</button>
            <span>${qty}</span>
            <button onclick="changeQty('${id}',1)">+</button>
          </div>
        </div>
      `;
      cartDiv.appendChild(div);
    }
  }
  subtotalEl.textContent = `Subtotal: ₵${subtotal.toFixed(2)}`;
}
loadCart();

// Quantity change
window.changeQty = function(id, delta){
  cart[id] += delta;
  if(cart[id] <= 0) delete cart[id];
  localStorage.setItem("cart", JSON.stringify(cart));
  loadCart();
}

// Paystack checkout
payBtn.addEventListener("click", () => {
  if(subtotal <= 0){ alert("Cart is empty"); return; }
  let handler = PaystackPop.setup({
    key: "YOUR_PAYSTACK_PUBLIC_KEY",
    email: "customer@example.com", // you can dynamically get this
    amount: subtotal * 100, // in kobo
    currency: "GHS",
    onClose: function(){ alert("Payment cancelled"); },
    callback: function(response){
      alert("Payment successful. Reference: " + response.reference);
      // TODO: Send payment confirmation to backend / Firebase
      localStorage.removeItem("cart");
      window.location.href = "../index.html";
    }
  });
  handler.openIframe();
});
</script>
</body>
</html>
